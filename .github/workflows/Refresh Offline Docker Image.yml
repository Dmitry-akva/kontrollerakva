name: Build Offline ESP8266 Image (Root Mode, Fixed)

on:
  workflow_dispatch:

jobs:
  build-offline-image:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Log in to GHCR
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      # 3️⃣ Build final image (Python + PlatformIO)
      - name: Build final image
        run: |
          docker build -t esp-final:latest -f Dockerfile.final .

      # 4️⃣ Run firmware build to populate PlatformIO cache
      - name: Build firmware (creates PlatformIO cache)
        run: |
          docker run --name pio_tmp \
            -u root \
            -v "${{ github.workspace }}":/workspace \
            -w /workspace \
            esp-final:latest \
            bash -lc "
              set -euo pipefail
              echo 'Running full build to populate PlatformIO cache...'
              pio run -v -j 4
            "

      # 5️⃣ Commit container as offline image
      - name: Commit container as offline image
        run: |
          docker commit pio_tmp ghcr.io/dmitry-akva/esp8266-platformio:offline-latest
          docker push ghcr.io/dmitry-akva/esp8266-platformio:offline-latest
          docker rm -f pio_tmp

      # 6️⃣ Verify cached libraries in final image
      - name: Check cached libraries and packages
        run: |
          IMAGE=ghcr.io/dmitry-akva/esp8266-platformio:offline-latest
          docker run --rm -u root -v "${{ github.workspace }}":/workspace -w /workspace $IMAGE bash -lc "
            echo '===== Cached libraries (.platformio/lib) ====='
            if [ -d \$PLATFORMIO_HOME_DIR/lib ]; then
              ls -1 \$PLATFORMIO_HOME_DIR/lib
            else
              echo '(empty)'
            fi

            echo '===== Cached packages (.platformio/packages) ====='
            if [ -d \$PLATFORMIO_HOME_DIR/packages ]; then
              ls -1 \$PLATFORMIO_HOME_DIR/packages
            else
              echo '(empty)'
            fi
          "
