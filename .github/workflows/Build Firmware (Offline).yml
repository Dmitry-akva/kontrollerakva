name: Build Firmware Offline (Final)

on:
  workflow_dispatch:

jobs:
  build-offline-final:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout repository
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2. Pull offline image с прогретым кешем
      # -----------------------------
      - name: Pull offline Docker image
        run: |
          docker pull ghcr.io/dmitry-akva/esp8266-platformio:offline-final

      # -----------------------------
      # 3. Build firmware внутри контейнера
      # -----------------------------
      - name: Compile firmware (offline)
        run: |
          docker run --rm -v $GITHUB_WORKSPACE:/workspace -w /workspace ghcr.io/dmitry-akva/esp8266-platformio:offline-final bash -lc "
            set -euo pipefail

            echo '===== Installing local libraries if missing ====='
            for lib in lib/*; do
              [ -d \"\$lib\" ] || continue
              pio pkg install --library \"\$lib\" || true
            done

            echo '===== Running full build ====='
            pio run -v
          "

      # -----------------------------
      # 4. Проверка кешей
      # -----------------------------
      - name: Check cached libraries and packages
        run: |
          docker run --rm ghcr.io/dmitry-akva/esp8266-platformio:offline-final bash -lc "
            echo '===== Cached packages (.platformio/packages) ====='
            ls -1 /root/.platformio/packages || echo '(empty)'

            echo '===== Cached libraries (.platformio/lib) ====='
            ls -1 /root/.platformio/lib || echo '(empty)'
          "
