name: Build Docker + ESP8266 Firmware

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'lib/**'
      - 'platformio.ini'
      - 'Dockerfile'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  docker:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –ö–µ—à PlatformIO (–±–∏–±–ª–∏–æ—Ç–µ–∫–∏, —Ç—É–ª—á–µ–π–Ω—ã, —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏)
      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
          key: pio-${{ runner.os }}-${{ hashFiles('platformio.ini') }}
          restore-keys: |
            pio-${{ runner.os }}-

      # 3Ô∏è‚É£ –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      # 4Ô∏è‚É£ –í–∫–ª—é—á–∞–µ–º Docker Buildx (–Ω—É–∂–Ω–æ –¥–ª—è –∫–µ—à–∞)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 5Ô∏è‚É£ –ö–µ—à Docker —Å–ª–æ—ë–≤
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: docker-${{ runner.os }}-${{ hashFiles('Dockerfile') }}
          restore-keys: |
            docker-${{ runner.os }}-

      # 6Ô∏è‚É£ –°–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞ —Å –∫–µ—à–µ–º
      - name: Build Docker image
        run: |
          docker buildx build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -t ghcr.io/dmitry-akva/esp8266-platformio:latest \
            --load .

      # 7Ô∏è‚É£ –û–±–Ω–æ–≤–ª—è–µ–º –∫–µ—à Docker
      - name: Move Docker cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      # 8Ô∏è‚É£ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—Ä–∞–∑–∞ –≤ GHCR
      - name: Push Docker image to GHCR
        run: docker push ghcr.io/dmitry-akva/esp8266-platformio:latest

      # 9Ô∏è‚É£ –°–±–æ—Ä–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—Å –∫–µ—à–µ–º PlatformIO)
      - name: Build firmware
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -v ~/.platformio:/root/.platformio \
            ghcr.io/dmitry-akva/esp8266-platformio:latest \
            pio run -j 4

      # üîü –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—à–∏–≤–∫—É –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: Upload firmware binary
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: .pio/build/nodemcuv2/firmware.bin
