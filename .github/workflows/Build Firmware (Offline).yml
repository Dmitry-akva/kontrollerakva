name: Build Firmware Offline

on:
  workflow_dispatch:

jobs:
  build-offline-firmware:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout repository
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # 2. Build final Docker image (Python + PlatformIO)
      # -----------------------------
      - name: Build Docker image
        run: |
          docker build -t esp-final:latest -f Dockerfile.final .

      # -----------------------------
      # 3. Create container, copy project, compile firmware
      # -----------------------------
      - name: Compile firmware inside container
        run: |
          # Создаём контейнер от образа
          CONTAINER=$(docker create -it esp-final:latest /bin/bash)

          # Копируем репозиторий внутрь контейнера
          docker cp $GITHUB_WORKSPACE/. $CONTAINER:/workspace

          # Запускаем сборку от root
          docker exec -u root -w /workspace $CONTAINER bash -lc "
            set -euo pipefail

            echo '===== Installing local libraries ====='
            for lib in lib/*; do
              [ -d \"\$lib\" ] || continue
              pio pkg install --library \"\$lib\" || true
            done

            echo '===== Running full build ====='
            pio run -v
          "

          # Сохраняем контейнер как новый образ с прогретым кешем
          docker commit $CONTAINER ghcr.io/dmitry-akva/esp8266-platformio:offline-latest

          # Удаляем временный контейнер
          docker rm -f $CONTAINER

      # -----------------------------
      # 4. Проверка кешей внутри образа
      # -----------------------------
      - name: Check cached libraries
        run: |
          docker run --rm ghcr.io/dmitry-akva/esp8266-platformio:offline-latest bash -lc "
            echo '===== Cached packages (.platformio/packages) ====='
            ls -1 /root/.platformio/packages
            echo '===== Cached libraries (.platformio/lib) ====='
            ls -1 /root/.platformio/lib || echo '(empty)'
          "
