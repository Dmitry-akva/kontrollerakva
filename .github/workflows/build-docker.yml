name: Build Offline Docker Image

on:
  workflow_dispatch:   # ручной запуск


jobs:
  build-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Compute image tag and lowercase repo
        id: meta
        run: |
          # hash для тега (platformio.ini)
          HASH="$(sha256sum platformio.ini | cut -d' ' -f1)"
          # приводим имя репозитория к lowercase (docker требует lowercase)
          REPO_LOWER="$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')"
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "repo=$REPO_LOWER" >> $GITHUB_OUTPUT
          echo "Computed IMAGE: ghcr.io/${REPO_LOWER}/esp8266-platformio:${HASH}"

      - name: Build and push Docker image (if missing)
        env:
          IMAGE: ghcr.io/${{ steps.meta.outputs.repo }}/esp8266-platformio:${{ steps.meta.outputs.hash }}
        run: |
          echo "Using image: $IMAGE"
          # Попробуем сначала подтянуть образ — если найден, пропускаем билд
          if docker pull "$IMAGE"; then
            echo "Image already exists: $IMAGE"
            exit 0
          fi

          echo "Image not found, building: $IMAGE"
          # Собираем образ (убирай --no-cache чтобы использовать слои кэша)
          docker build -t "$IMAGE" .
          echo "Pushing image: $IMAGE"
          docker push "$IMAGE"

      - name: Show pushed image info
        if: success()
        run: |
          IMAGE=ghcr.io/${{ steps.meta.outputs.repo }}/esp8266-platformio:${{ steps.meta.outputs.hash }}
          echo "Built/pushed: $IMAGE"
          docker image inspect "$IMAGE" || true
