name: Build ESP8266 Firmware (Offline + Save Cache)

on:
  push:
    paths:
      - 'src/**'
      - 'platformio.ini'
  workflow_dispatch:

jobs:
  build-and-save-cache:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”‘ Login to GHCR
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: ðŸ”½ Prepare image variable (lowercase)
        id: img
        run: |
          IMAGE=ghcr.io/$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]'):latest
          echo "IMAGE=$IMAGE" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Pull offline PlatformIO image
        run: |
          docker pull ${{ steps.img.outputs.IMAGE }}

      - name: ðŸ”¢ Count initial /platformio files in image
        id: initial
        run: |
          IMAGE=${{ steps.img.outputs.IMAGE }}
          # ÐµÑÐ»Ð¸ /platformio Ð½ÐµÑ‚, ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ 0
          INITIAL_COUNT=$(docker run --rm $IMAGE bash -c "if [ -d /platformio ]; then find /platformio -type f | wc -l; else echo 0; fi")
          echo "initial=$INITIAL_COUNT" >> $GITHUB_OUTPUT
          echo "Initial count: $INITIAL_COUNT"

      - name: ðŸ›  Run build (may populate cache) inside named container
        run: |
          IMAGE=${{ steps.img.outputs.IMAGE }}
          # Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ñ Ð¸Ð¼ÐµÐ½ÐµÐ¼, Ð¼Ð¾Ð½Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ workspace
          docker run --name pio_cache_tmp -d \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            $IMAGE bash -c "sleep 1d" >/dev/null
          # Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ (Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ). allow failure - ÑÐ±Ð¾Ñ€ÐºÐ° Ð¼Ð¾Ð¶ÐµÑ‚ Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ non-zero, Ð½Ð¾ ÐºÐµÑˆ Ð²ÑÑ‘ Ñ€Ð°Ð²Ð½Ð¾ Ð¿Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑÑ
          docker exec pio_cache_tmp bash -lc "pio run || true"
        # Ð•ÑÐ»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð¿Ð¾ ÐºÐ°ÐºÐ¾Ð¹-Ñ‚Ð¾ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ðµ Ð¿Ð¾Ð²Ð¸ÑÐ½ÐµÑ‚, Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸ ÑƒÐ±ÐµÑ€ÑƒÑ‚ ÐµÐ³Ð¾.

      - name: ðŸ”¢ Count post /platformio files in container
        id: post
        run: |
          INITIAL=${{ steps.initial.outputs.initial }}
          POST_COUNT=$(docker exec pio_cache_tmp bash -c "if [ -d /platformio ]; then find /platformio -type f | wc -l; else echo 0; fi")
          echo "post=$POST_COUNT" >> $GITHUB_OUTPUT
          echo "Initial: $INITIAL   Post: $POST_COUNT"

      - name: ðŸ’¾ Commit & push updated image if cache increased
        if: ${{ steps.post.outputs.post && (int(steps.post.outputs.post) > int(steps.initial.outputs.initial)) }}
        env:
          IMAGE: ${{ steps.img.outputs.IMAGE }}
          SHORT_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          echo "Cache increased â€” committing container -> image and pushing."
          # Tag with SHA as backup and also update :latest
          SHA_TAG="${IMAGE%:*}:cache-${SHORT_SHA::8}"
          echo "Committing container to image $IMAGE and $SHA_TAG"
          docker commit pio_cache_tmp "$IMAGE"
          docker tag "$IMAGE" "$SHA_TAG"
          docker push "$IMAGE"
          docker push "$SHA_TAG"
          # export /platformio to artifact file
          mkdir -p ./platformio_cache
          echo "Copying /platformio from container to runner..."
          docker cp pio_cache_tmp:/platformio ./platformio_cache || true
          tar -czf platformio_cache.tar.gz platformio_cache || true
          ls -lh platformio_cache.tar.gz || true

      - name: ðŸ§¹ Cleanup temporary container
        if: always()
        run: |
          docker rm -f pio_cache_tmp || true

      - name: ðŸ“¤ Upload platformio cache artifact (if present)
        if: ${{ always() && (steps.post.outputs.post && (int(steps.post.outputs.post) > int(steps.initial.outputs.initial))) }}
        uses: actions/upload-artifact@v4
        with:
          name: platformio-cache
          path: platformio_cache.tar.gz

      - name: ðŸ§° Final offline build (use cache in image) and upload firmware
        run: |
          IMAGE=${{ steps.img.outputs.IMAGE }}
          # run final offline build (shouldn't download anything)
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            $IMAGE \
            pio run
      - name: ðŸ“¤ Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: |
            .pio/build/*/*.bin
            .pio/build/*/*.elf
