name: Build Offline ESP8266 Image (Root mode)

on:
  workflow_dispatch:

jobs:
  build-offline-image:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Log in to GHCR
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      # 3. Build base image
      - name: Build base image
        run: |
          docker build -t esp-base:latest -f Dockerfile.base .

      # 4. Start container от root и прогрев кеша
      - name: Populate PlatformIO cache
        run: |
          docker run --name pio_tmp \
            -u root \
            -v "${{ github.workspace }}":/workspace \
            -w /workspace \
            -d esp-base:latest tail -f /dev/null

          # Установка локальных библиотек и прогрев кеша
          docker exec pio_tmp bash -lc "
            set -euo pipefail
            echo 'Installing local libraries...'
            for lib in /workspace/lib/*; do
              [ -d \"\$lib\" ] || continue
              echo \"Installing library: \$lib\"
              pio pkg install --library \"\$lib\"
            done
            echo 'Running full build to populate cache...'
            pio run -v -j 4
          "

          # Копируем кеш на хост
          rm -rf platformio_cache || true
          mkdir -p platformio_cache
          docker cp pio_tmp:/home/pio/.platformio ./platformio_cache/.platformio

          # Проверка содержимого кеша
          echo "=== platformio_cache/.platformio/lib ==="
          ls -1 platformio_cache/.platformio/lib || true
          echo "=== platformio_cache/.platformio/packages ==="
          ls -1 platformio_cache/.platformio/packages || true

          docker rm -f pio_tmp

      # 5. Build final offline image
      - name: Build final offline image
        run: |
          IMAGE=ghcr.io/dmitry-akva/esp8266-platformio
          TAG_SHA=${GITHUB_SHA::7}

          docker build \
            -t $IMAGE:offline-$TAG_SHA \
            -t $IMAGE:offline-latest \
            -f Dockerfile.final .

          docker push $IMAGE:offline-$TAG_SHA
          docker push $IMAGE:offline-latest

      # 6. Test libraries in final image (от root)
      - name: Verify cached libraries in final image
        run: |
          IMAGE=ghcr.io/dmitry-akva/esp8266-platformio:offline-latest
          docker run --rm -u root -v "${{ github.workspace }}":/workspace -w /workspace $IMAGE bash -lc "
            echo '===== Cached libraries in final image ====='
            ls -1 \$PLATFORMIO_HOME_DIR/lib || echo '(empty)'
            ls -1 \$PLATFORMIO_HOME_DIR/packages || echo '(empty)'
          "
