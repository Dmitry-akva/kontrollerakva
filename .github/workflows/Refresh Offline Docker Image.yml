name: Refresh Offline Docker Image

on:
  workflow_dispatch:

jobs:
  refresh-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      # üëâ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ë–ï–ó --rm, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
      - name: Build project inside container (populate PlatformIO cache)
        run: |
          docker run --name pio_cache_builder \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/dmitry-akva/esp8266-platformio:offline \
            pio run -v -j 4

      # (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ —É–≤–∏–¥–µ—Ç—å —Ä–∞–∑–º–µ—Ä –∫—ç—à–∞)
      - name: Show PlatformIO cache size
        run: docker exec pio_cache_builder du -sh /root/.platformio || true

      # üëâ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞–∫ –ù–û–í–´–ô –æ–±—Ä–∞–∑
      - name: Commit updated container to new image
        run: |
          docker commit pio_cache_builder ghcr.io/dmitry-akva/esp8266-platformio:offline-latest

      # üëâ –ü—É—à–∏–º –µ–≥–æ –≤ —Ä–µ–µ—Å—Ç—Ä
      - name: Push updated offline image
        run: |
          docker push ghcr.io/dmitry-akva/esp8266-platformio:offline-latest

      # üëâ –ß–∏—Å—Ç–∏–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      - name: Remove temporary container
        run: docker rm pio_cache_builder || true
