name: Build Optimized Offline Docker Image

on:
  workflow_dispatch:

jobs:
  build-offline-image:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- Log in to GHCR ---
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      # --- Build new offline image ---
      - name: Build Docker image with cached libs
        run: |
          docker build --pull -t ghcr.io/dmitry-akva/esp8266-platformio:offline-latest .

      # --- Start temporary container to verify caches ---
      - name: Start temporary container
        run: |
          docker run --name pio_cache_builder \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -d ghcr.io/dmitry-akva/esp8266-platformio:offline-latest tail -f /dev/null

      # --- Проверка кеша библиотек ---
      - name: List cached libraries in container
        run: |
          docker exec pio_cache_builder bash -lc "ls -R /root/.platformio/lib"

      # --- Тестовая сборка в контейнере (offline) ---
      - name: Test offline build in container
        run: |
          docker exec pio_cache_builder bash -lc "
            echo '[env:nodemcuv2]\nplatform=espressif8266\nboard=nodemcuv2\nframework=arduino' > platformio.ini
            mkdir -p src
            echo 'void setup(){} void loop(){}' > src/main.cpp
            pio run -e nodemcuv2 -v -j 4 || true
            rm -rf src platformio.ini .pio
          "

      # --- Commit контейнер как новый offline image ---
      - name: Commit container as new offline image
        run: docker commit pio_cache_builder ghcr.io/dmitry-akva/esp8266-platformio:offline-latest

      # --- Push new offline image to GHCR ---
      - name: Push offline image to GHCR
        run: docker push ghcr.io/dmitry-akva/esp8266-platformio:offline-latest

      # --- Cleanup temporary container ---
      - name: Remove temporary container
        run: docker rm -f pio_cache_builder || true
