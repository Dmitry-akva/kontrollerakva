name: Build Firmware Offline

on:
  workflow_dispatch:

jobs:
  build-offline-firmware:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1. Checkout repository
      # -----------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------
      # 2. Build final offline image
      # -----------------------------
      - name: Build Docker image
        run: |
          docker build -t esp-final:latest -f Dockerfile.final .

      # -----------------------------
      # 3. Create container, copy project, compile
      # -----------------------------
      - name: Compile firmware inside container
        run: |
          # Создаём контейнер
          CONTAINER=$(docker create -it esp-final:latest /bin/bash)
          
          # Копируем весь репозиторий внутрь контейнера
          docker cp $GITHUB_WORKSPACE/. $CONTAINER:/workspace

          # Запускаем сборку от root
          docker start -ai $CONTAINER bash -c "
            cd /workspace
            echo '===== Installing local libraries ====='
            for lib in lib/*; do
              [ -d \"\$lib\" ] || continue
              pio pkg install --library \"\$lib\"
            done
            echo '===== Running full build ====='
            pio run -v
          "

          # Сохраняем состояние контейнера в образ
          docker commit $CONTAINER ghcr.io/dmitry-akva/esp8266-platformio:offline-latest

          # Удаляем временный контейнер
          docker rm -f $CONTAINER

      # -----------------------------
      # 4. Проверка кешей внутри образа
      # -----------------------------
      - name: Check cached libraries
        run: |
          docker run --rm ghcr.io/dmitry-akva/esp8266-platformio:offline-latest bash -lc "
            echo '===== Cached packages ====='
            ls -1 /root/.platformio/packages
            echo '===== Cached libs ====='
            ls -1 /root/.platformio/lib || echo '(empty)'
          "
