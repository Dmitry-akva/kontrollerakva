name: Build ESP8266 Sketch

on:
  push:
    tags: ['v*']  # workflow –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–≥–∏ v*

permissions:
  contents: write  # –Ω—É–∂–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–ª–∏–∑–∞

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Arduino CLI —á–µ—Ä–µ–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Action
      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v2
        with:
          version: 1.3.1

      # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Arduino CLI
      - name: Check Arduino CLI
        run: arduino-cli version

      # 4. –ö—ç—à ESP8266 core
      - name: Cache ESP8266 platform
        id: cache-esp8266-core
        uses: actions/cache@v3
        with:
          path: ~/.arduino15/packages/esp8266
          key: esp8266-core-Linux-v3.1.2

      # 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ESP8266 core (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫—ç—à –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)
      - name: Install ESP8266 core
        if: steps.cache-esp8266-core.outputs.cache-hit != 'true'
        run: |
          arduino-cli config init --additional-urls http://arduino.esp8266.com/stable/package_esp8266com_index.json
          arduino-cli core update-index
          arduino-cli core install esp8266:esp8266@3.1.2

      # 6. –ö—ç—à –±–∏–±–ª–∏–æ—Ç–µ–∫ Arduino
      - name: Cache Arduino libraries
        uses: actions/cache@v3
        with:
          path: ~/Arduino/libraries
          key: arduino-libraries-${{ hashFiles('**/*.ino', '**/library.properties') }}

      # 7. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –ø—Ä–æ–µ–∫—Ç–∞
      - name: Install project libraries
        run: |
          arduino-cli lib update-index
          arduino-cli lib install "FastBot"
          arduino-cli lib install "OneWire"
          arduino-cli lib install "DallasTemperature"
          arduino-cli lib install "FileData"
          
          arduino-cli lib install "GyverPortal"
          arduino-cli lib install "GyverHC595"
          arduino-cli lib install "GTimer"

      # 8. –û—á–∏—Å—Ç–∫–∞ –ø–∞–ø–∫–∏ build
      - name: Clean build folder
        run: |
          rm -rf ./build
          mkdir -p ./build/esp8266

      # 9. –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Å–∫–µ—Ç—á–∞ Blink —Å —ç–∫—Å–ø–æ—Ä—Ç–æ–º HEX –∏ BIN
      - name: Compile Blink sketch
        run: | 
                   
          arduino-cli compile \
            --fqbn esp8266:esp8266:nodemcuv2 \
            --build-path ./build/esp8266 \
            --export-binaries \
            --verbose ./Blink/Blink.ino 2>&1 | tee raw-log.txt

          echo "==============================" > build-log.txt
          echo "üì¶ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:" >> build-log.txt
          echo "==============================" >> build-log.txt
          grep -A2 "Using library" raw-log.txt >> build-log.txt

          echo "" >> build-log.txt
          echo "==============================" >> build-log.txt
          echo "üíæ –û—Ç—á—ë—Ç –æ –ø–∞–º—è—Ç–∏:" >> build-log.txt
          echo "==============================" >> build-log.txt
          grep -E "used [0-9]+ / [0-9]+ bytes" raw-log.txt >> build-log.txt
          arduino-cli board details --fqbn esp8266:esp8266:nodemcuv2 >> build-log.txt

      # 10. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
      - name: List build files
        run: ls -la ./build/esp8266/

      # 11. –°–æ–∑–¥–∞–Ω–∏–µ zip –∞—Ä—Ö–∏–≤–∞ build –¥–ª—è —Ä–µ–ª–∏–∑–∞
      - name: Zip build folder
        run: |
          cd ./build
          zip -r esp8266-build.zip esp8266

      # 12. –°–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Release –Ω–∞ GitHub
      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            ./build/esp8266/*.bin
            ./build/esp8266/*.elf
            ./build/esp8266/*.map
            ./build/esp8266-build.zip
            ./build-log.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}